name: tests
on:
  - push
jobs:
  tests:
    strategy:
      matrix:
        pg_version: [13, 14, 15, 16, 17, 18]
        os: [ubuntu-latest] #[ ubuntu-latest, centos-latest]
    runs-on: ${{matrix.os}}
    steps:
      - name: install  apt  deps
        if: contains(matrix.os, 'ubuntu')
        run: |
          sudo apt update -y && sudo apt install -y rustup flex bison pkg-config  libssl-dev libreadline-dev zlib1g-dev libclang-dev clang
      - name: install rpm deps
        if: contains(matrix.os, 'centos')
        run: |
          echo TBD
      - run: rustup default stable
      - run: cargo install --locked cargo-pgrx
      - name: Check out repository code
        uses: actions/checkout@v5
      - run: |
          export PGRX_HOME=`pwd`/.pgrx
          export PGRX_PG_CONFIG_PATH=$(cargo pgrx info pg-config pg${{matrix.pg_version}} || echo 'download' )
          cargo pgrx init  -vv --pg${{ matrix.pg_version}} $PGRX_PG_CONFIG_PATH
      - run: |
          export PGRX_HOME=`pwd`/.pgrx
          export PGRX_PG_CONFIG_PATH=$(cargo pgrx info pg-config pg${{matrix.pg_version}})
          rm -rf target
          cargo pgrx  test -vv pg${{ matrix.pg_version }}
